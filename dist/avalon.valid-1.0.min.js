/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(t){"use strict";function n(){this.error=s,this.validating=!1,this.async=!1,this.func=!1,this.isPass=!0}function i(n){this.validating=!1,this.success="",this.error="",this.validators=[],this.clear=function(){this.success="",this.error=""},this.isPass=function(){var n=!0,i="",r="";return t.each(this.validators,function(t,a){if(a.isPass&&!r)i=a.success.val(a);else if(!r)return r=a.error.val(a),i="",n=!1,!1}),{success:i,error:r,isPass:n}},this.classBindings=[],this.displayBindings=[],this.validatings=[],this.invokeResult=function(){for(var n,i=this,r=""==i.error,a=0;a<i.classBindings.length;a++){n=i.classBindings[a];var e=n.name.split("-").pop(),s="success"==e?r:!r;t(n.element).toggleClass(n.clz,s)}for(var a=0;a<i.displayBindings.length;a++){n=i.displayBindings[a];var e=n.name.split("-").pop(),l="display"!=e?i[e]:i.success||i.error;t.innerHTML(n.element,l)}},this.valid=function(n){function i(){var e=a.shift();t.isFunction(e)?e():e.func(n,function(t){e.isPass=t,t?i():(r.error=e.error.val(e),a.pop()())})}var r=this;r.validating=!0;var a=[];for(var e in r.validators)a.push(r.validators[e]);r.error="",a.push(function(){r.invokeResult()}),i()},this._name=n,this.toString=function(){return this._name}}function r(t,n){var i=typeof n;switch(i){case"number":t=parseFloat(t);case"booleam":t="true"==t.toCaseLower()}return t}var a="val",e="$"+a,s={val:function(){return""}},l={getValidObj:function(n){var r=n.vmodels[0],a=n.expr.split(":"),s=a[a.length>1?1:0],l=null;return t.log("debug create validObj for ",s),r[e]||(r[e]={valida:function(){}}),l=r[e][s],l||(l=new i(s),r[e][s]=l),l}},o=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi,u={create:function(n){for(var i={},r=0;r<n.attributes.length;r++){var e=n.attributes[r];if(/^val-/gi.test(e.name)){var s=e.name.substr(4).split("-"),l=s.pop();if(0!=s.length){var o=s.shift(),u=t[a][o];if(u){var c=i[o];c||(c=this._creatorValidator(u,s,l,e),i[o]=c)}else t.log("warn","can't find",o," defined.")}}}return i},_creatorValidator:function(i,a,e,s){var l=new n,o=i(),u=s.val;t.mix(l,o);for(var c=l;0!=a.length;)if(c=c[a.shift()],void 0===c)return t.log("warn",e,"is not exist."),l;return c[e]="error"==e?this._createAttributeReader(s):r(u,c[e]),t.log("debug",e,"=",c[e]),l},_createAttributeReader:function(n){return{attr:n,val:function(n){var i=this.attr.value;if(n){var r=i.match(o);t.each(r,function(t,r){var a=r.substring(1,r.length-1);i=i.replace(new RegExp("\\["+a+"\\]","ig"),n[a].val())})}return i}}}};t.directive(a,{init:function(t){var n=l.getValidObj(t);if("ms-val"==t.name){var i=u.create(t.element);return n.validators=i,void c.validator(t)}"ms-val-class"==t.name.substr(0,"ms-val-class".length)?(c["class"](t),n.classBindings.push(t)):"ms-val-display"==t.name.substr(0,"ms-val-display".length)&&(t.oneTime=!0,n.displayBindings.push(t))},update:function(t,n){var i=void 0===n,r=l.getValidObj(this);return i?void(r.value=t):void r.valid(t)}});var c={validator:function(n){function i(){l.getValidObj(n).valid(this.value)}var r=n.element;t(r).bind("blur",i),n.roolback=function(){t(r).unbind("blur",i)}},"class":function(n,i){var r=n.expr.split(":");if(r.length<2)throw t.log("error",n.expr+" 必须是 className:bindgName"),new Exception(n.expr+" 必须是 className:bindgName");var a=r[1];n.expr=a,n.clz=r[0],n.oneTime=!0}};t[a]={required:function(){return{func:function(t,n){n(null!=t&&""!=t)}}},maxlen:function(){return{length:10,func:function(t,n){var i=parseInt(this.length);n(t.toString().length<=i)}}},minlen:function(){return{length:6,func:function(t,n){var i=parseInt(this.length);n(t.toString().length>=i)}}},range:function(){return{min:!1,max:!1,func:function(n,i){var r=parseFloat(this.max.val()),a=parseFloat(this.min.val()),e=parseFloat(n),s=e>=a&&r>=e;t.log("range "+s),i(s)}}}}}(avalon);