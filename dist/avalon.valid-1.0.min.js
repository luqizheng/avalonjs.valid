/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(n){"use strict";function t(){this.error=function(){return"输入错误情纠正"},this.async=!1,this.func=!1,this.isPass=!0,this.init=n.noop}function i(t){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=null,this.output=function(){var t=this,i=this.isPass();n.each(t.classBindings,function(t,r){var a=r.name.split("-").pop(),e="success"===a?i:!i;n(r.element).toggleClass(r.clz,e)}),n.each(t.displayBindings,function(r,a){var e=a.name.split("-").pop(),s=i?t.success:t.error;"success"===e&&(s=i?t.success:""),"error"===e&&(s=i?"":t.error),n.innerHTML(a.element,s)})},this.getValue=function(){var n=this.binding;return n.getter?n.getter.apply(0,n.args):n.oldValue},this.isSameValue=function(n){var t=this.binding;return t.getter?(void 0===n&&(n=t.getter.apply(0,t.args)),n&&n===t.oldValue):!0},this.valid=function(t,r){function a(){e.validating=!0;var r=s.shift();n.isFunction(r)?r():r.func(t,function(n){if(r.isPass=n,n)a();else{var t=r.error(e);e.error=i(t,r,e),s.pop()()}})}var e=this;if(this.isSameValue(t)&&!r)return void r.call(e,e.isPass());void 0===t&&(t=this.getValue()),e.validating=!0,e.error="";var s=[];for(var o in e.validators)s.push(e.validators[o]);return s.push(function(){e.validating=!1,e.output(),r&&r.call(e,e.isPass())}),a(),!0},this._name=t,this.name=t,this.toString=function(){return this._name},this.isPass=function(){return""===this.error},this.notifyValidators=[],this.notify=function(){n.each(this.notifyValidators,function(n,t){t.vObj.valid()})};var i=function(t,i,r){var a=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi,e=t.match(a);return n.each(e,function(n,a){var e=a.substring(1,a.length-1),s=i,o="vObj";e.subStr(0,o.length)===o&&(e=e.split(".")[1],s=r),t=t.replace(new RegExp("\\["+e+"\\]","ig"),s[e])}),t}}function r(n,t){switch(t){case"number":n=parseFloat(n);break;case"booleam":n="true"===n.toCaseLower();break;case"function":n=function(){return this.attr.value}}return n}function a(t,i,a,e){for(var s,o=i.pop(),l=t;0!==i.length;)if(s=i.shift(),l=l[s],void 0===l)return n.log("warn",s,"is not exist."),!1;e||(e=typeof l[o]),l[o]=r(a,e)}function e(n){return n.substr(0,s["class"].length)===s["class"]?s["class"]:n.substr(0,s.display.length)===s.display?s.display:n.substr(0,s.val.length)===s.val?s.val:void 0}var s={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},o="val",l="$val",u={getValidObj:function(t){var r=this._findVm(t.vmodels),a=t.expr.split(":"),e=a[a.length>1?1:0],s=null,o=t.args[0].$id;r[l]||(r[l]={valid:function(t){var i=[],r=!0;u._vObjLoop.call(this,function(n,t){i.push(n+"."+t)}),u._vObjLoop.call(this,function(a,e){this[a][e].valid(void 0,function(a){r=r&&a,n.Array.remove(i,this.$compId+"."+this.name),i.length||t(r)})})}});var c=r[l][o];return c||(r[l][o]=c={}),s=c[e],s||(s=new i(e),s.binding=t,s.comp=c,s.$compId=o,c[e]=s,n.log("debug","created validation obj in ."+l+"."+o+"."+e)),s},_findVm:function(t){var i;return n.each(t,function(n,t){return"$proxy"===t.$id.substr(0,"$proxy".length)?!0:(i=t,!1)}),i},_vObjLoop:function(n){for(var t in this)if("valid"!==t)for(var i in this[t])n.call(this,t,i)}},c={create:function(t,i){for(var r={},e=t.element,s=0;s<e.attributes.length;s++){var l=e.attributes[s];if(/^val-/gi.test(l.name)){var u=l.name.substr(4).split("-"),c=u.shift(),v=n[o][c];if(v){var h=r[c];h||(h=this._creatorValidator(v,u,l),r[c]=h,h.vObj=i),h.init(t,i)}else u=[c].concat(u),a(i,u,l.value)}}return r},_creatorValidator:function(i,r,e){var s=new t;s.attr=e;var o=i(),l=r.length>0?r[r.length-1]:!1;return n.mix(s,o),l&&a(s,r,e.value),s}},v={"class":function(t){var i=t.expr.split(":");i.length<2&&n.log("error",t.expr+" 必须是 className:bindgName");var r=i[1];t.expr=r,t.clz=i[0],t.oneTime=!0}};n.directive(o,{init:function(t){var i=e(t.name);if(i===s["class"])v["class"](t);else if(i===s.display)t.oneTime=!0;else if(i===s.val){var r=t.element,a=function(){var n=u.getValidObj(t);n.valid()};n(r).bind("blur",a),t.roolback=function(){n(r).unbind("blur",a)}}},update:function(t,i){var r=void 0===i,a=this,o=u.getValidObj(a);if(r){var l=e(a.name);return l===s.val?void(o.validators=c.create(a,o)):void(l===s["class"]?o.classBindings.push(a):l===s.display?(a.oneTime=!0,o.displayBindings.push(a)):n.log("warn",a.name+" do not support."))}o.valid(t),o.notify()}}),n[o]={required:function(){return{func:function(n,t){t(null!==n&&""!==n)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(n,t){var i=parseInt(this.length);t(n.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(n,t){var i=parseInt(this.length);t(n.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:1,max:200,func:function(n,t){var i=parseFloat(this.max.val()),r=parseFloat(this.min.val()),a=parseFloat(n),e=a>=r&&i>=a;t(e)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},equal:function(){return{compare:"",func:function(n,t){var i=this.vObj.comp[this.compare].getValue();t(i==n)},error:function(n){var t=n.desc||n.name,i=this.vObj.comp[this.compare],r=i.name||i._name;return t+"与"+r+"不一致"},init:function(n,t){var i=this.vObj.comp[this.compare];i.notifyValidators.push(this)}}},regex:function(){return{patten:"",func:function(n,t){var i=new RegExp(this.patten);t(i.text(n))},error:function(n){return(n.name||n._name)+"不正确"}}}}}(avalon);