/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(t){"use strict";function n(){this.error=function(){return"输入错误情纠正"},this.async=!1,this.func=!1,this.init=t.noop}function i(n){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=null,this.enabled=!0,this.group="",this._isFristVal=!0,this.output=function(){var n=this,i=this.isPass();t.each(n.classBindings,function(n,r){var e=r.name.split("-").pop(),a="success"===e?i:!i;t(r.element).toggleClass(r.clz,a)}),t.each(n.displayBindings,function(r,e){var a=e.name.split("-").pop(),s=i?n.success:n.error;"success"===a&&(s=i?n.success:""),"error"===a&&(s=i?"":n.error),t.innerHTML(e.element,s)})},this.getValue=function(){var t=this.binding;return t.getter?t.getter.apply(0,t.args):t.oldValue},this.isSameValue=function(t){if(this._isFristVal)return this._isFirstVal=!1,!1;var n=this.binding;return n.getter?(void 0===t&&(t=n.getter.apply(0,n.args)),t&&t===n.oldValue):!0},this.valid=function(n,r){function e(){a.validating=!0;var r=s.shift();t.isFunction(r)?r():r.func(n,function(t){if(t)e();else{var n=r.error(a);a.error=i(n,r,a),s.pop()()}})}var a=this;if(a.enabled){if(void 0===n&&(n=this.getValue()),this.isSameValue(n))return void(t.isFunction(r)&&r.call(a,a.isPass()));a.validating=!0,a.error="";var s=[];for(var o in a.validators)s.push(a.validators[o]);return s.push(function(){a.validating=!1,a.output(),r&&r.call(a,a.isPass())}),e(),!0}},this._name=n,this.name=n,this.toString=function(){return this._name},this.isPass=function(){return!this.enabled||""===this.error},this.notifyValidators=[],this.notify=function(){t.each(this.notifyValidators,function(t,n){n.vObj.valid()})};var i=function(n,i,r){var e=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi,a=n.match(e);return t.each(a,function(t,e){var a=e.substring(1,e.length-1),s=a,o=i,l="vObj";a.substr(0,l.length)===l&&(s=a.split(".")[1],o=r),n=n.replace(new RegExp("\\["+a+"\\]","ig"),o[s])}),n}}function r(t,n){switch(n){case"number":t=parseFloat(t);break;case"booleam":t="true"===t.toCaseLower();break;case"function":t=function(){return this.attr.value}}return t}function e(n,i,e,a){for(var s,o=i.pop(),l=n;0!==i.length;)if(s=i.shift(),l=l[s],void 0===l)return t.log("warn",s,"is not exist."),!1;a||(a=typeof l[o]),l[o]=r(e,a)}function a(t){return t.substr(0,s["class"].length)===s["class"]?s["class"]:t.substr(0,s.display.length)===s.display?s.display:t.substr(0,s.val.length)===s.val?s.val:void 0}var s={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},o="val",l="$val",u={getValidObj:function(n){var r=this._findVm(n.vmodels),e=n.expr.split(":"),a=e[e.length>1?1:0],s=null,o=n.args[0].$id;r[l]||(r[l]={valid:function(n){var i=[],r=!0;u._vObjLoop.call(this,function(t,n){i.push(t+"."+n)}),u._vObjLoop.call(this,function(e,a,s){s.valid(void 0,function(e){r=r&&e,t.Array.remove(i,this.$compId+"."+this._name),i.length||n(r)})})},enable:function(t,n){u._vObjLoop.call(this,function(i,r,e){e.group==t&&(e.enabled=n)})}});var c=r[l][o];return c||(r[l][o]=c={}),s=c[a],s||(s=new i(a),s.binding=n,s.comp=c,s.$compId=o,c[a]=s,t.log("debug","created validation obj in ."+l+"."+o+"."+a)),s},_findVm:function(n){var i;return t.each(n,function(t,n){return"$proxy"===n.$id.substr(0,"$proxy".length)?!0:(i=n,!1)}),i},_vObjLoop:function(t){for(var n in this)if("valid"!==n)for(var i in this[n])t.call(this,n,i,this[n][i])}},c={create:function(n,i){for(var r={},a=n.element,s=0;s<a.attributes.length;s++){var l=a.attributes[s];if(/^val-/gi.test(l.name)){var u=l.name.substr(4).split("-"),c=u.shift(),h=t[o][c];if(h){var v=r[c];v||(v=this._creatorValidator(h,u,l),r[c]=v,v.vObj=i),v.init(n,i)}else u=[c].concat(u),e(i,u,l.value)}}return r},_creatorValidator:function(i,r,a){var s=new n;s.attr=a;var o=i(),l=r.length>0?r[r.length-1]:!1;return t.mix(s,o),l&&e(s,r,a.value),s}},h={"class":function(n){var i=n.expr.split(":");i.length<2&&t.log("error",n.expr+" 必须是 className:bindgName");var r=i[1];n.expr=r,n.clz=i[0],n.oneTime=!0}};t.directive(o,{init:function(n){var i=a(n.name);if(i===s["class"])h["class"](n);else if(i===s.display)n.oneTime=!0;else if(i===s.val){var r=n.element,e=function(){var t=u.getValidObj(n);t.valid()};t(r).bind("blur",e),n.roolback=function(){t(r).unbind("blur",e)}}},update:function(n,i){var r=void 0===i,e=this,o=u.getValidObj(e);if(r){var l=a(e.name);return l===s.val?void(o.validators=c.create(e,o)):void(l===s["class"]?o.classBindings.push(e):l===s.display?(e.oneTime=!0,o.displayBindings.push(e)):t.log("warn",e.name+" do not support."))}o.valid(n),o.notify()}}),t[o]={required:function(){return{func:function(t,n){n(null!==t&&""!==t)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(t,n){var i=parseInt(this.length);n(t.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(t,n){var i=parseInt(this.length);n(t.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:1,max:200,func:function(t,n){var i=parseFloat(this.max.val()),r=parseFloat(this.min.val()),e=parseFloat(t),a=e>=r&&i>=e;n(a)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},equal:function(){return{compare:"",func:function(t,n){var i=this.vObj.comp[this.compare].getValue();n(i==t)},error:function(t){var n=t.desc||t.name,i=this.vObj.comp[this.compare],r=i.name||i._name;return n+"与"+r+"不一致"},init:function(t,n){var i=this.vObj.comp[this.compare];i.notifyValidators.push(this)}}},regex:function(){return{pattern:"",func:function(t,n){var i=new RegExp(this.pattern);n(i.test(t))},error:function(t){return(t.name||t._name)+"不正确"}}}}}(avalon);