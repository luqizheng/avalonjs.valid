/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(n){"use strict";function t(){this.error=function(n){return"输入错误情纠正"},this.async=!1,this.func=!1,this.init=n.noop,this.attrs={}}function i(t){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=null,this.enabled=!0,this.group="",this._isFristVal=!0,this.output=function(){var t=this,i=this.isPass();n.each(t.classBindings,function(t,r){var e=r.name.split("-").pop(),a="success"===e?i:!i;n(r.element).toggleClass(r.clz,a)}),n.each(t.displayBindings,function(r,e){var a=e.name.split("-").pop(),s=i?t.success:t.error;"success"===a&&(s=i?t.success:""),"error"===a&&(s=i?"":t.error),n.innerHTML(e.element,s)})},this.getValue=function(){var n=this.binding;return n.getter?n.getter.apply(0,n.args):n.oldValue},this.isSameValue=function(n){if(this._isFristVal)return this._isFirstVal=!1,!1;var t=this.binding;return t.getter?(void 0===n&&(n=t.getter.apply(0,t.args)),n&&n===t.oldValue):!0},this.valid=function(t,r){function e(){a.validating=!0;var r=s.shift();n.isFunction(r)?r():r.func(t,function(n){if(n)e();else{var t=r.error(a);a.error=i(t,r,a),s.pop()()}})}var a=this;if(a.enabled){if(void 0===t&&(t=this.getValue()),this.isSameValue(t))return void(n.isFunction(r)&&r.call(a,a.isPass()));a.validating=!0,a.error="";var s=[];for(var o in a.validators)s.push(a.validators[o]);return s.push(function(){a.validating=!1,a.output(),r&&r.call(a,a.isPass())}),e(),!0}},this._propertyName=t,this.name=t,this.toString=function(){return this._propertyName},this.isPass=function(){return!this.enabled||""===this.error},this.notifyValidators=[],this.notify=function(){n.each(this.notifyValidators,function(n,t){t.vObj.valid()})};var i=function(t,i,r){var e=t.match(/\[([^\[\]]|\[([^\[\]])*\])*\]/gi);return n.each(e,function(e,a){var s=a.substring(1,a.length-1),o=s,u=i,l="vObj";s.substr(0,l.length)===l&&(o=s.split(".")[1],u=r);var c=u[o];n.isFunction(c)&&(c=c()),t=t.replace(new RegExp("\\["+s+"\\]","ig"),c)}),t}}function r(n){return function(){var t=n;return t.value}}function e(n,t,i){switch(t){case"number":n=parseFloat(n);break;case"booleam":n="true"===n.toCaseLower();break;case"function":n=r(i)}return n}function a(t,i,r,a){for(var s,o=i.pop(),u=t;0!==i.length;)if(s=i.shift(),u=u[s],void 0===u)return n.log("warn",s,"is not exist."),!1;var l=typeof u[o];u[o]=e(r,l,a)}function s(n){return n.substr(0,c["class"].length)===c["class"]?c["class"]:n.substr(0,c.display.length)===c.display?c.display:n.substr(0,c.val.length)===c.val?c.val:void 0}function o(n){return function(){return n}}function u(t,i){return{compare:"",value:n.noop,func:function(n,i){var r,e=this.vObj.comp[this.compare];r=e?e.getValue():this.value(),t(n,r,i)},error:function(n){var t=n.name||n._propertyName,r=this.vObj.comp[this.compare],e=r?r.name||r._propertyName:this.compare||this.value();return i(t,e)},init:function(n,t){var i=this.vObj.comp[this.compare],r=this;if(i)i.notifyValidators.push(this);else for(var e=0;e<n.vmodels.length;e++){var a=n.vmodels[e];if(a[this.compare]){r.value=o(a[this.compare]),a.$watch(this.compare,function(n){r.valid()});break}}}}}function l(n,t){return{func:function(t,i){i(t?n.test(t):!0)},error:function(){return t}}}var c={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},f="val",v="$val",h={getValidObj:function(t){var r=this._findVm(t.vmodels),e=t.expr.split(":"),a=e[e.length>1?1:0],s=null,o=t.args[0].$id;r[v]||(r[v]={valid:function(t){var i=[],r=!0;h._vObjLoop.call(this,function(n,t){i.push(n+"."+t)}),h._vObjLoop.call(this,function(e,a,s){s.valid(void 0,function(e){r=r&&e,n.Array.remove(i,this.$compId+"."+this._propertyName),i.length||t(r)})})},enable:function(n,t){h._vObjLoop.call(this,function(i,r,e){e.group==n&&(e.enabled=t)})}});var u=r[v][o];return u||(r[v][o]=u={}),s=u[a],s||(s=new i(a),s.binding=t,s.comp=u,s.$compId=o,u[a]=s,n.log("debug","created validation obj in ."+v+"."+o+"."+a)),s},_findVm:function(t){var i;return n.each(t,function(n,t){return"$proxy"===t.$id.substr(0,"$proxy".length)?!0:(i=t,!1)}),i},_vObjLoop:function(n){for(var t in this)if("valid"!==t)for(var i in this[t])n.call(this,t,i,this[t][i])}},p={create:function(t,i){for(var r={},e=t.element,s=0;s<e.attributes.length;s++){var o=e.attributes[s];if(/^val-/gi.test(o.name)){var u=o.name.substr(4).split("-"),l=u.shift(),c=n[f][l];if(c){var v=r[l];v?a(v,u,o.value,o):(v=this._creatorValidator(c,u,o),r[l]=v,v.vObj=i),v.init(t,i)}else u=[l].concat(u),a(i,u,o.value)}}return r},_creatorValidator:function(i,r,e){var s=new t,o=i(),u=r.length>0?r[r.length-1]:!1;return n.mix(s,o),u&&a(s,r,e.value,e),s}},d={"class":function(t){var i=t.expr.split(":");i.length<2&&n.log("error",t.expr+"必须是",t.expr,'="className:bindName 这种格式');var r=i[1];t.expr=r,t.clz=i[0],t.oneTime=!0}};n.directive(f,{init:function(t){var i=s(t.name);if(i===c["class"])d["class"](t);else if(i===c.display)t.oneTime=!0;else if(i===c.val){var r=t.element,e=function(){var n=h.getValidObj(t);n.valid()};n(r).bind("blur",e),t.roolback=function(){n(r).unbind("blur",e)}}},update:function(t,i){var r=void 0===i,e=this,a=h.getValidObj(e);if(r){var o=s(e.name);return o===c.val?void(a.validators=p.create(e,a)):void(o===c["class"]?a.classBindings.push(e):o===c.display?(e.oneTime=!0,a.displayBindings.push(e)):n.log("warn",e.name+" do not support."))}a.valid(t),a.notify()}}),n[f]={required:function(){return{func:function(n,t){t(null!==n&&""!==n)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(n,t){var i=parseInt(this.length);t(n.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(n,t){var i=parseInt(this.length);t(n.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:n.noop,max:n.noop,func:function(t,i){var r=parseFloat(this.max()),e=parseFloat(this.min());(e===0/0||r===0/0)&&n.log("error","Please defined val-range-min/max attr for "+this.vObj._name);var a=parseFloat(t),s=a>=e&&r>=a;i(s)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},regex:function(){return{pattern:"",func:function(n,t){var i=new RegExp(this.pattern);t(i.test(n))},error:function(n,t){return"[vObj.name]格式不正确"}}},"int":function(){return l(/^\-?\d+$/,"请输入整数")},email:function(){return l(/^([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+@([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+\.[A-Z]{2,3}$/i,"请输入正确的电子邮件")},qq:function(){return l(/^[1-9]\d{4,10}$/,"请输入正确的qq号码")},chs:function(){return l(/^[\u4e00-\u9fa5]+$/,"请输入中文")},eq:function(){return u(function(n,t,i){i(n==t)},function(n,t){return n+"与"+t+"不一致"})},lt:function(){return u(function(n,t,i){i(t>n)},function(n,t){return"请确保"+n+"要少于"+t})},gt:function(){return u(function(n,t,i){i(n>t)},function(n,t){return"请确保"+n+"要大于"+t})}}}(avalon);