/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(t){"use strict";function n(){this.error=function(t){return"输入错误情纠正"},this.async=!1,this.func=!1,this.init=t.noop,this.attrs={}}function i(n){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=null,this.enabled=!0,this.group="",this._isFristVal=!0,this.output=function(){var n=this,i=this.isPass();t.each(n.classBindings,function(n,r){var e=r.name.split("-").pop(),a="success"===e?i:!i;t(r.element).toggleClass(r.clz,a)}),t.each(n.displayBindings,function(r,e){var a=e.name.split("-").pop(),s=i?n.success:n.error;"success"===a&&(s=i?n.success:""),"error"===a&&(s=i?"":n.error),t.innerHTML(e.element,s)})},this.getValue=function(){var t=this.binding;return t.getter?t.getter.apply(0,t.args):t.oldValue},this.isSameValue=function(t){if(this._isFristVal)return this._isFirstVal=!1,!1;var n=this.binding;return n.getter?(void 0===t&&(t=n.getter.apply(0,n.args)),t&&t===n.oldValue):!0},this.valid=function(n,r){function e(){a.validating=!0;var r=s.shift();t.isFunction(r)?r():r.func(n,function(t){if(t)e();else{var n=r.error();a.error=i(n,r,a),s.pop()()}})}var a=this;if(a.enabled){if(void 0===n&&(n=this.getValue()),this.isSameValue(n))return void(t.isFunction(r)&&r.call(a,a.isPass()));a.validating=!0,a.error="";var s=[];for(var o in a.validators)s.push(a.validators[o]);return s.push(function(){a.validating=!1,a.output(),r&&r.call(a,a.isPass())}),e(),!0}},this._propertyName=n,this.name=n,this.toString=function(){return this._propertyName},this.isPass=function(){return!this.enabled||""===this.error},this.notifyValidators=[],this.notify=function(){t.each(this.notifyValidators,function(t,n){n.vObj.valid()})};var i=function(n,i,r){var e=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi,a=n.match(e);return t.each(a,function(e,a){var s=a.substring(1,a.length-1),o=s,u=i,l="vObj";s.substr(0,l.length)===l&&(o=s.split(".")[1],u=r);var c=u[o];t.isFunction(c)&&(c=c()),n=n.replace(new RegExp("\\["+s+"\\]","ig"),c)}),n}}function r(t){return function(){var n=t;return n.value}}function e(t,n,i){switch(n){case"number":t=parseFloat(t);break;case"booleam":t="true"===t.toCaseLower();break;case"function":t=r(i)}return t}function a(n,i,r,a){for(var s,o=i.pop(),u=n;0!==i.length;)if(s=i.shift(),u=u[s],void 0===u)return t.log("warn",s,"is not exist."),!1;var l=typeof u[o];u[o]=e(r,l,a)}function s(t){return t.substr(0,o["class"].length)===o["class"]?o["class"]:t.substr(0,o.display.length)===o.display?o.display:t.substr(0,o.val.length)===o.val?o.val:void 0}var o={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},u="val",l="$val",c={getValidObj:function(n){var r=this._findVm(n.vmodels),e=n.expr.split(":"),a=e[e.length>1?1:0],s=null,o=n.args[0].$id;r[l]||(r[l]={valid:function(n){var i=[],r=!0;c._vObjLoop.call(this,function(t,n){i.push(t+"."+n)}),c._vObjLoop.call(this,function(e,a,s){s.valid(void 0,function(e){r=r&&e,t.Array.remove(i,this.$compId+"."+this._propertyName),i.length||n(r)})})},enable:function(t,n){c._vObjLoop.call(this,function(i,r,e){e.group==t&&(e.enabled=n)})}});var u=r[l][o];return u||(r[l][o]=u={}),s=u[a],s||(s=new i(a),s.binding=n,s.comp=u,s.$compId=o,u[a]=s,t.log("debug","created validation obj in ."+l+"."+o+"."+a)),s},_findVm:function(n){var i;return t.each(n,function(t,n){return"$proxy"===n.$id.substr(0,"$proxy".length)?!0:(i=n,!1)}),i},_vObjLoop:function(t){for(var n in this)if("valid"!==n)for(var i in this[n])t.call(this,n,i,this[n][i])}},f={create:function(n,i){for(var r={},e=n.element,s=0;s<e.attributes.length;s++){var o=e.attributes[s];if(/^val-/gi.test(o.name)){var l=o.name.substr(4).split("-"),c=l.shift(),f=t[u][c];if(f){var v=r[c];v?a(v,l,o.value,o):(v=this._creatorValidator(f,l,o),r[c]=v,v.vObj=i),v.init(n,i)}else l=[c].concat(l),a(i,l,o.value)}}return r},_creatorValidator:function(i,r,e){var s=new n,o=i(),u=r.length>0?r[r.length-1]:!1;return t.mix(s,o),u&&a(s,r,e.value,e),s}},v={"class":function(n){var i=n.expr.split(":");i.length<2&&t.log("error",n.expr+" 必须是 className:bindgName");var r=i[1];n.expr=r,n.clz=i[0],n.oneTime=!0}};t.directive(u,{init:function(n){var i=s(n.name);if(i===o["class"])v["class"](n);else if(i===o.display)n.oneTime=!0;else if(i===o.val){var r=n.element,e=function(){var t=c.getValidObj(n);t.valid()};t(r).bind("blur",e),n.roolback=function(){t(r).unbind("blur",e)}}},update:function(n,i){var r=void 0===i,e=this,a=c.getValidObj(e);if(r){var u=s(e.name);return u===o.val?void(a.validators=f.create(e,a)):void(u===o["class"]?a.classBindings.push(e):u===o.display?(e.oneTime=!0,a.displayBindings.push(e)):t.log("warn",e.name+" do not support."))}a.valid(n),a.notify()}}),t[u]={required:function(){return{func:function(t,n){n(null!==t&&""!==t)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(t,n){var i=parseInt(this.length);n(t.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(t,n){var i=parseInt(this.length);n(t.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:t.noop,max:t.noop,func:function(n,i){var r=parseFloat(this.max()),e=parseFloat(this.min());(e===0/0||r===0/0)&&t.log("error","Please defined val-range-min/max attr for "+this.vObj._name);var a=parseFloat(n),s=a>=e&&r>=a;i(s)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},equal:function(){return{compare:"",func:function(t,n){var i=this.vObj.comp[this.compare].getValue();n(i==t)},error:function(t,n){var i=t.name||t._propertyName,r=this.vObj.comp[this.compare],e=r.name||r._propertyName;return i+"与"+e+"不一致"},init:function(t,n){var i=this.vObj.comp[this.compare];i.notifyValidators.push(this)}}},regex:function(){return{pattern:"",func:function(t,n){var i=new RegExp(this.pattern);n(i.test(t))},error:function(t,n){return"[vObj.name]不正确"}}},"int":function(){return{func:function(t,n){n(/^\-?\d+$/.test(t))},error:function(t){return"请输入整数"}}}}}(avalon);