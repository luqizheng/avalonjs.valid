/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(n){"use strict";function t(){this.error=function(){return"输入错误情纠正"},this.async=!1,this.func=!1,this.isPass=!0,this.init=n.noop}function i(t){this.validating=!1,this.success="正确",this.error="",this.validators=[],this.value="",this.classBindings=[],this.displayBindings=[],this.binding=null,this.output=function(){var t=this,i=""==t.error;n.each(t.classBindings,function(t,r){var a=r.name.split("-").pop(),e="success"==a?i:!i;n(r.element).toggleClass(r.clz,e)}),n.each(t.displayBindings,function(r,a){var e=a.name.split("-").pop(),s=i?t.success:t.error;"success"==e&&(s=i?t.success:""),"error"==e&&(s=i?"":t.error),n.innerHTML(a.element,s)})},this.valid=function(t,r){function a(){e.validating=!0;var r=s.shift();n.isFunction(r)?r():r.func(t,function(n){if(r.isPass=n,n)a();else{var t=r.error(e);e.error=i(t),s.pop()()}})}var e=this;if(e.validating=!0,e.error="",""!=e.value&&e.value==t)return!1;void 0===t&&(t=e.value);var s=[];for(var o in e.validators)s.push(e.validators[o]);return s.push(function(){e.value=t,e.validating=!1,e.output(),r&&r.call(e,e.isPass())}),a(),!0},this.name=t,this.toString=function(){return this.name},this.isPass=function(){return""==this.error},this.notifyValidators=[],this.notify=function(){n.each(this.notifyValidators,function(n,t){t.vObj.valid(void 0)})};var i=function(t){var i=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi,r=t.match(i);return n.each(r,function(n,i){var r=i.substring(1,i.length-1);t=t.replace(new RegExp("\\["+r+"\\]","ig"),validator[r].val())}),t}}function r(t,i,r,e){for(var s=i.pop(),o=t;0!=i.length;)if(o=o[i.shift()],void 0===o)return n.log("warn",propName,"is not exist."),!1;e||(e=typeof o[s]),o[s]=a(r,e),n.log("debug",s,"=",o[s])}function a(n,t){switch(t){case"number":n=parseFloat(n);break;case"booleam":n="true"==n.toCaseLower();break;case"function":n=function(){return this.attr.value}}return n}var e="val",s="$"+e,o={val:"ms-val","class":"ms-val-class",display:"ms-val-display"},l={getValidObj:function(t){var r=t.vmodels[t.vmodels.length-1],a=t.expr.split(":"),e=a[a.length>1?1:0],o=null,l=t.args[0].$id;r[s]||(r[s]={valid:function(t){var i=[],r=!0;for(var a in this)"valid"!=a&&i.push(a);for(;0!=i.length;){var a=i.shift();this[a].valid(void 0,function(a){n.log(this.name),r=r&&a,n.Array.remove(i,this.name),0==i.length&&t(r)})}}});var u=r[s][l];return u||(u={},r[s][l]=u),o=u[e],o||(o=new i(e),o.binding=t,o.comp=u,u[e]=o,n.log("debug","created validation obj in ."+s+"."+l+"."+e)),o}},u={create:function(t,i){for(var a={},s=t.element,o=0;o<s.attributes.length;o++){var l=s.attributes[o];if(/^val-/gi.test(l.name)){var u=l.name.substr(4).split("-"),c=u.shift(),v=n[e][c];if(v){var f=a[c];f||(f=this._creatorValidator(v,u,l),a[c]=f,f.vObj=i),f.init(t,i)}else u=[c].concat(u),r(i,u,l.value)}}return a},_creatorValidator:function(i,a,e){var s=new t;s.attr=e;var o=i(),l=a.length>0?a[a.length-1]:!1;return n.mix(s,o),l&&r(s,a,e.value),s}};n.directive(e,{init:function(t){function i(){var n=t.getter?t.getter.apply(0,t.args):t.oldValue;l.getValidObj(t).valid(n)}if(t.name.substr(0,o["class"].length)==o["class"])c["class"](t);else if("ms-val-display"==t.name.substr(0,"ms-val-display".length))t.oneTime=!0;else if(t.name==o.val){var r=t.element;n(r).bind("blur",i),t.roolback=function(){n(r).unbind("blur",i)}}},update:function(t,i){var r=void 0===i,a=this,e=l.getValidObj(a);if(r){if(console.log("init "+a.uniqueNumber),a.name==o.val){if(a.name==o.val){var s=u.create(a,e);e.validators=s,c.validator(a)}return}return a.name.substr(0,o["class"].length)==o["class"]?e.classBindings.push(a):"ms-val-display"==a.name.substr(0,"ms-val-display".length)?(a.oneTime=!0,e.displayBindings.push(a)):n.log("warn",a.name+" do not support."),void(e.value=t)}e.valid(t),e.notify()}});var c={validator:function(n){return},"class":function(t,i){var r=t.expr.split(":");if(r.length<2)throw n.log("error",t.expr+" 必须是 className:bindgName"),new Exception(t.expr+" 必须是 className:bindgName");var a=r[1];t.expr=a,t.clz=r[0],t.oneTime=!0}};n[e]={required:function(){return{func:function(n,t){t(null!=n&&""!=n)},error:function(n){return"请输入"+n.name+"的值"}}},maxlen:function(){return{length:10,func:function(n,t){var i=parseInt(this.length);t(n.toString().length<=i)},error:function(n){return"最多只能输入"+this.length+"个字符"}}},minlen:function(){return{length:6,func:function(n,t){var i=parseInt(this.length);t(n.toString().length>=i)},error:function(n){return"请至少输入[length]个字符"}}},range:function(){return{min:1,max:200,func:function(n,t){var i=parseFloat(this.max.val()),r=parseFloat(this.min.val()),a=parseFloat(n),e=a>=r&&i>=a;t(e)},error:function(n){return"请输入的数值范围在[min]和[max]之间"}}},equal:function(){return{compare:"",func:function(n,t){var i=this.vObj.comp[this.compare].binding,r=i.getter.apply(0,i.args);t(r==n)},error:function(n){return"不一致"},init:function(n,t){var i=this.vObj.comp[this.compare];i.notifyValidators.push(this)}}}}}(avalon);