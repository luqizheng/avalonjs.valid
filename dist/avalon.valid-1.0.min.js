/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(n){function a(){this.success=v,this.error=v,this.validating=!1,this.async=!1,this.func=!1,this.isPass=!0}function i(){this.validating=!1,this.validators={},this.clear=function(){this.success="",this.error=""},this.isPass=function(){var a=!0,i="",t="";return n.each(this.validators,function(n,s){if(s.isPass&&!t)i=s.success.val(s);else if(!t)return t=s.error.val(s),i="",a=!1,!1}),{success:i,error:t,isPass:a}},this.classBindings=[],this.displayBindings=[],this.validatings=[],this.invokeResult=function(){var a=this,i=a.isPass(),t=i.isPass;console.log("isPass"+t);var s,r;console.debug("classBindings:"+a.classBindings.length);for(var l=0;l<a.classBindings.length;l++){s=a.classBindings[l],r=e(s);var o="success"==r.param?t:!t;n(s.element).toggleClass(s.clz,o)}for(var l=0;l<a.displayBindings.length;l++){s=a.displayBindings[l],r=e(s);var c=r.param?a[r.param]:i.success||i.error;n.innerHTML(s.element,c)}}}function t(n){var a=n.vmodels[0],t=n.expr.split(":"),s=t[0],e=null;return a[u]||(a[u]={}),e=a[u][s],e||(e=new i,a[u][s]=e),e}function s(n){var i=t(n),s=r(n),e=i.validators[s];return e||(e=new a,i.validators[s]=e),e}function e(n){var a=n.param.split("-"),i=a.length>1?a[1]:"";return{name:a[0].toLowerCase(),param:i}}function r(n){var a=n.param.split("-"),i=a[0],t=a.pop(),s=parseInt(t);return s&&(i+=s),i}function l(a,i){for(var t=a.element,s=a.type,e="data-"+s+"-"+a.param+"-",r=0;r<t.attributes.length;r++){var l=t.attributes[r],o=new RegExp(e+".*"),c=l.name.match(o);if(null!=c){var u=l.name.substr(e.length).split("-");if(0==u.length)continue;for(var v=u.pop(),g=i;0!=u.length;)g=g[u.shift()];g[v]={attr:l,val:function(a){var i=this.attr.value;if(a){var t=i.match(f);n.each(t,function(n,t){var s=t.substring(1,t.length-1);i=i.replace(new RegExp("\\["+s+"\\]","ig"),a[s].val())})}return i}}}}}function o(n){return"display"!=n&&"class"!=n}var c="val",u="$"+c,v={val:function(){return""}},f=/\[([^\[\]]|\[([^\[\]])*\])*\]/gi;n.directive(c,{init:function(a){var i=e(a);if(o(i.name))g.validator(a,i);else{var t=g[i.name];t?t(a,i):n.log("warning",i.name,"is not a validation")}},update:function(n,a){var i=void 0===a,s=this,r=e(s);if(i){if(!o(r.name)){var l=t(this);l[r.name+"Bindings"].push(this)}}else console.log("call output "+r.name),o(r.name)&&h.validator.call(this,n,r)}});var g={validator:function(a,i){function t(){h.validator.call(a,this.value,i)}var e=s(a),r=a.element,o=n[c][i.name];o||n.log("warning",i.name+" validator can't be found in avalon["+c+"]"),n.mix(e,o()),l(a,e,a.expr),n(r).bind("blur",t),a.roolback=function(){n(r).unbind("click",t)}},display:function(n,a){n.oneTime=!0},"class":function(a,i){var t=a.expr.split(":");if(t.length<2)throw n.log("error",a.expr+" 必须是 className:bindgName"),new Exception(a.expr+" 必须是 className:bindgName");var s=t[1];a.expr=s,a.clz=t[0],a.oneTime=!0}},h={validator:function(n,a){var i=this,s=t(i),e=s.validators[a.name];e.async&&(s.validating=!0),e.func(n,function(n){e.isPass=n,s.validating=!1,s.invokeResult()})}};n[c]={required:function(){return{func:function(n,a){a(null!=n&&""!=n)}}},maxlength:function(){return{length:10,func:function(n,a){var i=parseInt(this.length);a(n.toString().length<=i)}}},minlength:function(){return{length:6,func:function(n,a){var i=parseInt(this.length);a(n.toString().length>=i)}}},range:function(){return{min:!1,max:!1,func:function(a,i){var t=parseFloat(this.max.val()),s=parseFloat(this.min.val()),e=parseFloat(a),r=e>=s&&t>=e;n.log("range "+r),i(r)}}}}}(avalon);