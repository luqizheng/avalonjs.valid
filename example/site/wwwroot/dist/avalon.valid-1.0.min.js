/*!
avalon.valid Copyright(c) 2011 Leo.lu  MIT Licensed
https://github.com/luqizheng/avalon.valid.js 
*/
!function(n){"use strict";function t(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(){this.error=function(n){return"输入错误请纠正"},this.async=!1,this.func=!1,this.init=n.noop,this.inited=n.noop}function r(t,i){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=i,this.disabled=a("val-disabled",this),this.group=a("val-group",this),this._isFirstVal=!0,this.output=function(){var t=this,i=this.isPass();n.each(t.classBindings,function(t,r){var a=e(r),s="success"===a?i:!i;n(r.element).toggleClass(r.clz,s)}),n.each(t.displayBindings,function(r,a){var s=e(a),o=i?t.success:t.error;switch(s){case"success":o=i?t.success:"";break;case"error":o=i?"":t.error}n.innerHTML(a.element,o)})},this.getValue=function(){var n=this.binding;return n.getter?n.getter.apply(0,n.args):n.oldValue},this.isSameValue=function(n){if(this._isFirstVal)return this._isFirstVal=!1,!1;var t=this.binding;return t.getter?(void 0===n&&(n=t.getter.apply(0,t.args)),n&&n===t.oldValue):!0},this.valid=function(t,i){function e(){n.isFunction(i)&&i.call(s,s.isPass())}function a(){s.validating=!0;var i=o.shift();n.isFunction(i)?i():i.func(t,function(n){if(n)a();else{var t=i.error();s.error=r(t,i,s),o.pop()()}})}var s=this;if(s.disabled())return s.success="",s.output(),void e();if(void 0===t&&(t=this.getValue()),this.isSameValue(t))return void e();s.validating=!0,s.error="";var o=[];for(var u in s.validators)o.push(s.validators[u]);return o.push(function(){s.validating=!1,s.output(),e()}),a(),!0},this._propertyName=t,this.name=t,this.toString=function(){return this._propertyName},this.isPass=function(){return this.disabled()||""===this.error},this.notifyValidators=[],this.notify=function(){n.each(this.notifyValidators,function(n,t){t.vObj.valid()})};var r=function(t,i,r){var e=t.match(/\[([^\[\]]|\[([^\[\]])*\])*\]/gi);return n.each(e,function(e,a){var s=a.substring(1,a.length-1),o=s,u=i,l="vObj";s.substr(0,l.length)===l&&(o=s.split(".")[1],u=r);var c=u[o];n.isFunction(c)&&(c=c()),t=t.replace(new RegExp("\\["+s+"\\]","ig"),c)}),t}}function e(n){var t=n.name.split("-"),i=t.pop();return/^\d/.test(i)?t.pop():i}function a(n,t){return function(i,r){var e=n,a=t.binding,s=a.element.attributes[e];return void 0===i?s?s.value:"undefined"==typeof _inner?!1:_inner:(s&&(s.value=i),void(_inner=i))}}function s(n,t,i,r){switch(t){case"number":n=parseFloat(n);break;case"booleam":n="true"===n.toCaseLower();break;case"function":n=a(i.name,r)}return n}function o(n,t,i,r,e){for(var a,o=t.pop(),u=e||i.value,l=n;0!==t.length;)a=t.shift(),void 0===l[a]&&(l[a]={}),l=l[a];var c=typeof l[o];"undefined"==c&&(c=typeof u),l[o]=s(u,c,i,r)}function u(n){return n.substr(0,v["class"].length)===v["class"]?v["class"]:n.substr(0,v.display.length)===v.display?v.display:n.substr(0,v.val.length)===v.val?v.val:void 0}function l(n){return function(){return n}}function c(t,i){return{compare:"",value:n.noop,func:function(n,i){var r,e=this.vObj.comp[this.compare];r=e?e.getValue():this.value(),t(n,r,i)},error:function(){var n=this.vObj,t=this,r=n.name||n._propertyName,e=t.vObj.comp[t.compare],a=e?e.name||e._propertyName:t.compare||t.value();return i(r,a)},inited:function(n,t){var i=this,r=i.value(),e=i.vObj.comp[i.compare];if(void 0===r)if(e)e.notifyValidators.push(i);else for(var a=0;a<n.vmodels.length;a++){var s=n.vmodels[a];if(s[i.compare]){i.value=l(s[i.compare]),s.$watch(i.compare,function(n){t.valid()});break}}}}}function f(n,t){return{func:function(t,i){i(""===t?!0:n.test(t))},error:function(){return t}}}var v={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},d="val",h="$val",p={getValidObj:function(t){var i=this._findVm(t.vmodels),e=t.expr.split(":"),a=e[e.length>1?1:0],s=null,o=t.args[0].$id,u=i[h];u||(u=i[h]={bindings:{},valid:function(){var t={_len:0},i=!1,r=n.noop,e=!1,a=arguments,s=!0;if(1===a.length&&(r=a[0]),2===a.length&&(i=a[0],r=a[1]),i&&(e=i.$id,i.$ups))for(var o in i.$ups){e=i.$ups[o].$id;break}for(var o in this.bindings)if(!e||e==o){t[o]=this.bindings[o];for(var u in t[o])t._len++;if(e)break}for(var o in t)if("_len"!=o)for(var l in t[o]){var c=t[o][l];c.valid(void 0,function(n){s=s&&n,t._len--,0==t._len&&r&&r(s)})}},enable:function(n,t){void 0===t&&(t=n,n=!1);for(var i in this.bindings){var r=this.bindings[i];for(var e in r){var a=r[e];(n===!1||a.group==n)&&a.disabled(!t)}}}});var l=u.bindings[o];return l||(u.bindings[o]=l={}),s=l[a],s||(s=new r(a,t),s.binding=t,s.comp=l,s.$compId=o,l[a]=s),s},_findVm:function(t){var i,r="$proxy";return n.each(t,function(n,t){return t.$id.substr(0,r.length)===r?!0:(i=t,!1)}),i}},g={create:function(t,r){for(var e={},a=t.element,s=0;s<a.attributes.length;s++){var u=a.attributes[s];if(/^val-/gi.test(u.name)){var l=u.name.substr(4).split("-"),c=l.shift(),f=n[d][c];if(f){var v=e[c];v||(v=new i,n.mix(v,f()),e[c]=v,v.vObj=r,v.init(t,r)),o(v,l,u,r)}else l=[c].concat(l),o(r,l,u,r)}}for(var h in e)e[h].inited(t,r);return e}},m={"class":function(t){var i=t.expr.split(":");i.length<2&&n.log("error",t.expr+"必须是",t.expr,'="className:bindName 这种格式');var r=i[1];t.expr=r,t.clz=i[0],t.oneTime=!0}};n.directive(d,{init:function(t){var i=u(t.name);if(i===v["class"])m["class"](t);else if(i===v.display)t.oneTime=!0;else if(i===v.val){var r=t.element,e=function(){var n=p.getValidObj(t);n.valid()};n(r).bind("blur",e),t.roolback=function(){n(r).unbind("blur",e)}}},update:function(t,i){var r=void 0===i,e=this,a=p.getValidObj(e);if(r){var s=u(e.name);return s===v.val?(a.validators=g.create(e,a),void(a.binding=this)):void(s===v["class"]?a.classBindings.push(e):s===v.display?(e.oneTime=!0,a.displayBindings.push(e)):n.log("warn",e.name+" do not support."))}a.valid(t),a.notify()}}),n[d]={required:function(){return{func:function(n,i){i(t(n)?0!=n.length:null!==n&&""!==n)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(n,t){var i=parseInt(this.length);t(n.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(n,t){var i=parseInt(this.length);t(n.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:n.noop,max:n.noop,func:function(t,i){var r=parseFloat(this.max()),e=parseFloat(this.min());(e===0/0||r===0/0)&&n.log("error","Please defined val-range-min/max attr for "+this.vObj._name);var a=parseFloat(t),s=a>=e&&r>=a;i(s)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},regex:function(){return{pattern:"",func:function(n,t){var i=new RegExp(this.pattern);t(i.test(n))},error:function(n,t){return"[vObj.name]格式不正确"}}},"int":function(){return f(/^\-?\d+$/,"请输入整数")},email:function(){return f(/^([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+@([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+\.[A-Z]{2,3}$/i,"请输入正确的电子邮件")},qq:function(){return f(/^[1-9]\d{4,10}$/,"请输入正确的qq号码")},chs:function(){return f(/^[\u4e00-\u9fa5]+$/,"请输入中文")},eq:function(){return c(function(n,t,i){i(n==t)},function(n,t){return n+"与"+t+"不一致"})},lt:function(){return c(function(n,t,i){i(t>n)},function(n,t){return"请确保"+n+"要少于"+t})},gt:function(){return c(function(n,t,i){i(n>t)},function(n,t){return"请确保"+n+"要大于"+t})},ajax:function(){return{method:"get",url:"",data:{},func:function(n,t){var i={};for(var r in this.data)i[r]=this.data[r]();$.ajax({method:this.method,url:this.url,data:i,success:function(n){t(n)}})},init:function(t){for(var i=this,r=0;r<t.element.attributes.length;r++){var e=t.element.attributes[r];if(/val-ajax-data-.+/i.test(e.name)){var a=e.name.substr("val-ajax-data-".length).split("-");o(i.data,a,e,i.vObj,n.noop)}}}}}}}(avalon);