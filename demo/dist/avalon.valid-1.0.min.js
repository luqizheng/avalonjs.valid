!function(n){//http://chen.junchang.blog.163.com/blog/static/6344519201312514327466/
"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?define(function(){n(require("avalon"))}):"function"==typeof define&&define.amd?define(["avalon"],n):n(window.avalon)}(function(n){function t(n){return"[object Array]"===Object.prototype.toString.call(n)}function i(t,i){this.validating=!1,this.success="",this.$compId="",this.error="",this.validators=[],this.classBindings=[],this.displayBindings=[],this.binding=i,this._disabled=!1,this.disabled=function(n){return void 0===n?this._disabled:void(this._disabled=n)},this._group="",this.group=function(n){return void 0===n?this._group:void(this._group=n)},this._isFirstVal=!0,this.output=function(){var t=this,i=this.isPass();n.each(t.classBindings,function(t,r){var a=n(r.element),s=e(r),o="success"===s?i:!i;a.toggleClass(r.clz,o)}),n.each(t.displayBindings,function(r,a){var s=e(a),o=i?t.success:t.error;switch(s){case"success":o=i?t.success:"";break;case"error":o=i?"":t.error}n.innerHTML(a.element,o)})},this.reset=function(){n.each(self.classBindings,function(t,i){n(i.element).toggleClass(i.clz,!1)}),n.each(self.displayBindings,function(t,i){n.innerHTML(i.element,"")})},this.getValue=function(){var n=this.binding;return n.getter?n.getter.apply(0,n.args):n.oldValue},this.isSameValue=function(n){if(this._isFirstVal)return this._isFirstVal=!1,!1;var t=this.binding;return t.getter?(void 0===n&&(n=t.getter.apply(0,t.args)),n&&n===t.oldValue):!0},this.valid=function(t,i){function e(t){n.isFunction(i)&&i.call(s,s.isPass(),t)}function a(){s.validating=!0;var i=o.shift();n.isFunction(i)?i():i.func(t,function(n){if(n)a();else{var t=i.error();s.error=r(t,i,s),o.pop()(s.error)}},s)}var s=this;if(s.disabled())return s.success="",s.output(),void e();if(void 0===t&&(t=this.getValue()),this.isSameValue(t))return void e(null);s.validating=!0,s.error="";var o=[];for(var u in s.validators)o.push(s.validators[u]);return o.push(function(n){s.validating=!1,s.output(),e(n)}),a(),!0},this._propertyName=t,this.name=t,this.toString=function(){return this._propertyName},this.isPass=function(){return this.disabled()||""===this.error},this.notifyValidators=[],this.notify=function(){n.each(this.notifyValidators,function(n,t){t.vObj.valid()})};var r=function(t,i,e){var r=t.match(/\[([^\[\]]|\[([^\[\]])*\])*\]/gi);return n.each(r,function(r,a){var s=a.substring(1,a.length-1),o=s,u=i,l="vObj";s.substr(0,l.length)===l&&(o=s.split(".")[1],u=e);var c=u[o];n.isFunction(c)&&(c=c()),t=t.replace(new RegExp("\\["+s+"\\]","ig"),c)}),t}}function e(n){var t=n.name.split("-"),i=t.pop();return/^\d/.test(i)?t.pop():i}function r(n,t,i,e){var r=t,a=i,s=e,o=n;return function(n){var t=o.binding.element.attributes[r];if(void 0===n){switch(t&&(a=t.value),s){case"number":return parseFloat(a);case"boolean":return"true"==a&&void 0!=t}return console.log(r+"="+a+"("+e+")"),a}t&&(t.value=n),a=n}}function a(n,t,i,e){for(var a,s=t.pop(),o=n;0!==t.length;)a=t.shift(),void 0===o[a]&&(o[a]={}),o=o[a];var u=typeof o[s];("undefined"==u||"function"==u||"object"==u)&&(u="string"),o[s]=r(i,e.name,e.value,u)}function s(){this.error=function(n){return"输入错误请纠正"},this.func=!1,this.inited=n.noop}function o(n){return n.substr(0,f["class"].length)===f["class"]?f["class"]:n.substr(0,f.display.length)===f.display?f.display:n.substr(0,f.val.length)===f.val?f.val:void 0}function u(n){return function(){return n}}function l(n,t){return{compare:"",value:"",func:function(t,i){var e,r=this.compare(),a=this.vObj.comp[r];e=a?a.getValue():this.value(),n(t,e,i)},error:function(){var n=this.vObj,i=this,e=n.name||n._propertyName,r=i.vObj.comp[i.compare()],a=r?r.name||r._propertyName:i.compare()||i.value();return t(e,a)},inited:function(n,t){var i=this,e=i.value(),r=i.vObj.comp[i.compare()];if(void 0===e)if(r)r.notifyValidators.push(i);else for(var a=0;a<n.vmodels.length;a++){var s=n.vmodels[a];if(s[i.compare()]){i.value(u(s[i.compare()])),s.$watch(i.compare(),function(n){t.valid()});break}}}}}function c(n,t){return{func:function(t,i){i(""===t?!0:n.test(t))},error:function(){return t}}}var f={"class":"ms-val-class",display:"ms-val-display",val:"ms-val"},v="val",d="$val",h={getValidObj:function(t){var e=this._findVm(t.vmodels),r=t.expr.split(":"),a=r[r.length>1?1:0],s=null,o=t.args[0].$id,u=e[d];u||(u=e[d]={bindings:{},valid:function(){var t={_len:0},i=!1,e=n.noop,r=!1,a=arguments,s=!0;if(1===a.length&&(e=a[0]),2===a.length&&(i=a[0],e=a[1]),i&&(r=i.$id,i.$ups))for(var o in i.$ups){r=i.$ups[o].$id;break}for(var o in this.bindings)if(!r||r==o){t[o]=this.bindings[o];for(var u in t[o])t[o][u].reset(),t._len++;if(r)break}var l=[];for(var o in t)if("_len"!=o)for(var c in t[o]){var f=t[o][c];f.valid(void 0,function(n,i){s=s&&n,n||l.push({msg:i,vObj:f.name}),t._len--,0==t._len&&e&&e(s,l)})}},enable:function(n,t){for(var i in this.bindings){var e=this.bindings[i];for(var r in e){var a=e[r];(void 0===t||a.group()==t)&&a.disabled(!n)}}}});var l=u.bindings[o];return l||(u.bindings[o]=l={}),s=l[a],s||(s=new i(a,t),s.binding=t,s.comp=l,s.$compId=o,l[a]=s),s},_findVm:function(t){var i,e="$proxy";return n.each(t,function(n,t){return t.$id.substr(0,e.length)===e?!0:(i=t,!1)}),i}},p={create:function(t,i){for(var e={},o=t.element,u=0;u<o.attributes.length;u++){var l=o.attributes[u];if(/^val-/gi.test(l.name)){var c=l.name.substr(4).split("-"),f=c.shift(),d=n[v][f];if(d){var h=e[f];h||(h=new s,n.mix(h,d()),e[f]=h,h.vObj=i),0!=c.length&&a(h,c,i,l)}else{c=[f].concat(c);var p=i[f],g=typeof p;"function"==g&&(p=p.call(i),g=typeof p),console.log("set the vobject property "+f+",val="+p+",type="+g),i[f]=r(i,l.name,p,g)}}}for(var m in e){var h=e[m];for(var b in h){var y=typeof h[b];"function"!=y&&"object"!=y&&(h[b]=r(i,b,h[b],y))}h.inited(t,i)}return e}},g={"class":function(t){try{var i=t.expr.split(":");i.length<2&&n.log("error",t.expr+"必须是",t.expr,'="className:bindName 这种格式');var e=i[1];t.expr=e,t.clz=i[0],t.oneTime=!0}catch(r){console.log(r)}}};n.directive(v,{init:function(t){var i=o(t.name);if(i===f["class"])g["class"](t);else if(i===f.display)t.oneTime=!0;else if(i===f.val){var e=t.element,r=function(){var n=h.getValidObj(t);n.valid()};n(e).bind("blur",r),t.rollback=function(){n(e).unbind("blur",r)}}},update:function(t,i){var e=this,r=h.getValidObj(e);if(void 0===i){var a=o(e.name);return a===f.val?(r.validators=p.create(e,r),void(r.binding=this)):void(a===f["class"]?r.classBindings.push(e):a===f.display?(e.oneTime=!0,r.displayBindings.push(e)):n.log("warn",e.name+" do not support."))}r.valid(t),r.notify(),this.$vObj=r}}),n[v]={required:function(){return{func:function(n,i){i(t(n)?0!=n.length:null!==n&&""!==n)},error:function(){return"请输入[vObj.name]"}}},maxlen:function(){return{length:10,func:function(n,t){var i=parseInt(this.length());t(n.toString().length<=i)},error:function(){return"最多只能输入[length]个字符"}}},minlen:function(){return{length:6,func:function(n,t){var i=parseInt(this.length());t(n.toString().length>=i)},error:function(){return"请至少输入[length]个字符"}}},range:function(){return{min:n.noop,max:n.noop,func:function(t,i){var e=parseFloat(this.max()),r=parseFloat(this.min());(r===0/0||e===0/0)&&n.log("error","Please defined val-range-min/max attr for "+this.vObj._name);var a=parseFloat(t),s=a>=r&&e>=a;i(s)},error:function(){return"请输入的数值范围在[min]和[max]之间"}}},regex:function(){return{pattern:"",func:function(n,t){var i=new RegExp(this.pattern());t(i.test(n))},error:function(n,t){return"[vObj.name]格式不正确"}}},"int":function(){return c(/^\-?\d+$/,"请输入整数")},email:function(){return c(/^([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+@([A-Z0-9]+[_|\_|\.]?)*[A-Z0-9]+\.[A-Z]{2,3}$/i,"请输入正确的电子邮件")},qq:function(){return c(/^[1-9]\d{4,10}$/,"请输入正确的qq号码")},chs:function(){return c(/^[\u4e00-\u9fa5]+$/,"请输入中文")},eq:function(){return l(function(n,t,i){i(n==t)},function(n,t){return n+"与"+t+"不一致"})},lt:function(){return l(function(n,t,i){i(t>n)},function(n,t){return"请确保"+n+"要少于"+t})},gt:function(){return l(function(n,t,i){i(n>t)},function(n,t){return"请确保"+n+"要大于"+t})},ajax:function(){return{method:"get",url:"",data:function(n){for(var t={},i=0;i<n.attributes.length;i++){var e=binding.element.attributes[i];if(/val-ajax-data-.+/i.test(e.name)){for(var r=e.name.substr("val-ajax-data-".length).split("-"),a=r.pop(),s=t;0!=r.length;){var o=r.shift();void 0==s[o],s[o]={},s=s[o]}s[a]=e.value}}},func:function(n,t,i){var e=this.data(i.binding.element);$.ajax({method:this.method(),url:this.url(),data:e,success:function(n){t(n)}})}}}}});